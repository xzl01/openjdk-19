Description: Makes the timestamp in the javadoc files reproducible when SOURCE_DATE_EPOCH is specified
Author: Emmanuel Bourg <ebourg@apache.org>
Forwarded: no
--- a/src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/formats/html/markup/Head.java
+++ b/src/jdk.javadoc/share/classes/jdk/javadoc/internal/doclets/formats/html/markup/Head.java
@@ -239,6 +239,9 @@ public class Head {
      */
     public Content toContent() {
         Date now = showTimestamp ? calendar.getTime() : null;
+        if (now != null && System.getenv("SOURCE_DATE_EPOCH") != null) {
+            now = new Date(1000 * Long.parseLong(System.getenv("SOURCE_DATE_EPOCH")));
+        }
 
         HtmlTree tree = new HtmlTree(HtmlTag.HEAD);
         tree.add(getGeneratedBy(showTimestamp, now));
@@ -250,6 +253,9 @@ public class Head {
 
         if (showTimestamp) {
             SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
+            if (System.getenv("SOURCE_DATE_EPOCH") != null) {
+                dateFormat.setTimeZone(TimeZone.getTimeZone("UTC"));
+            }
             tree.add(HtmlTree.META("dc.created", dateFormat.format(now)));
         }
 
@@ -282,7 +288,14 @@ public class Head {
     private Comment getGeneratedBy(boolean timestamp, Date now) {
         String text = "Generated by javadoc"; // marker string, deliberately not localized
         if (timestamp) {
-            text += " ("+ docletVersion + ") on " + now;
+            text += " ("+ docletVersion + ") on ";
+            if (System.getenv("SOURCE_DATE_EPOCH") == null) {
+                text += now;
+            } else {
+                SimpleDateFormat fmt = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss z");
+                fmt.setTimeZone(TimeZone.getTimeZone("UTC"));
+                text += fmt.format(now);
+            }
         }
         return new Comment(text);
     }
